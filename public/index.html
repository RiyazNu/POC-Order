<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment & Auth Mismatch Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }
        .controls select, .controls button {
            padding: 8px 15px;
            margin: 0 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .controls button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        .controls button:hover {
            background: #0056b3;
        }
        
        /* Tab styling */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            border: none;
            background: none;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab:hover {
            color: #007bff;
        }
        .tab.active {
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }
        
        /* Tab content */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
            font-size: 14px;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #e9ecef;
        }
        .total-row {
            background-color: #e7f3ff !important;
            font-weight: bold;
        }
        .auth-mismatch-row:hover {
            background-color: #ffeaea !important;
        }
        .last-updated {
            text-align: center;
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .summary-box {
            margin-top: 25px;
            padding: 15px;
            background: #f0f7ff;
            border-left: 5px solid #007bff;
            border-radius: 6px;
            font-size: 15px;
        }
        .error-box {
            margin-top: 25px;
            padding: 15px;
            background: #ffeaea;
            border-left: 5px solid #dc3545;
            border-radius: 6px;
            font-size: 15px;
            color: #721c24;
        }
        .stats-box {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat-card {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }
        .stat-card .count {
            font-size: 28px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-card .label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        /* Auth mismatch specific styling */
        .auth-table th {
            background-color: #fff5f5;
        }
        .auth-table td {
            text-align: right;
        }
        .auth-table td:first-child {
            text-align: left;
        }
        .negative-diff {
            color: #dc3545;
            font-weight: bold;
        }
        .positive-diff {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <select id="hoursSelect">
                <option value="1">Last 1 Hour</option>
                <option value="4">Last 4 Hours</option>
                <option value="6" selected>Last 6 Hours</option>
                <option value="12">Last 12 Hours</option>
                <option value="24">Last 24 Hours</option>
            </select>
            <button onclick="loadActiveTabData()">Refresh Data</button>
        </div>

        <div class="header">
            <h1>Payment & Auth Mismatch Dashboard</h1>
            <div id="timeRangeTitle">Last 6 Hours</div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('payment')">Payment Details</button>
            <button class="tab" onclick="switchTab('authMismatch')">Auth Mismatch</button>
        </div>
        
        <!-- Payment Details Tab -->
        <div id="paymentTab" class="tab-content active">
            <div class="table-container">
                <table id="paymentTable">
                    <thead>
                        <tr>
                            <th>Payment Method</th>
                            <th>US</th>
                            <th>CA</th>
                            <th>TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="paymentTableBody">
                        <tr>
                            <td colspan="4" class="loading">Loading payment data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="paymentSummaryBox" class="summary-box">
                Summary loading...
            </div>
        </div>
        
        <!-- Auth Mismatch Tab -->
        <div id="authMismatchTab" class="tab-content">
            <!-- Stats Cards -->
            <div id="authStatsBox" class="stats-box">
                <div class="stat-card">
                    <h3>Auth Mismatch Count</h3>
                    <div class="count" id="authMismatchCount">0</div>
                    <div class="label">Orders with mismatch</div>
                </div>
                <div class="stat-card">
                    <h3>Total Difference</h3>
                    <div class="count" id="totalDifference">$0</div>
                    <div class="label">Amount difference</div>
                </div>
                <div class="stat-card">
                    <h3>Total Amount Paid</h3>
                    <div class="count" id="totalAmountPaid">$0</div>
                    <div class="label">Total paid amount</div>
                </div>
            </div>

            <div class="table-container">
                <table id="authMismatchTable" class="auth-table">
                    <thead>
                        <tr>
                            <th>Placed On</th>
                            <th>Order ID</th>
                            <th>Site</th>
                            <th>Price w/o Tax</th>
                            <th>Tax & Shipping</th>
                            <th>Amount Paid</th>
                            <th>Difference</th>
                            <th>CC/PayPal</th>
                            <th>GC/Reward</th>
                            <th>Payment Count</th>
                        </tr>
                    </thead>
                    <tbody id="authMismatchTableBody">
                        <tr>
                            <td colspan="10" class="loading">Loading auth mismatch data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="authSummaryBox" class="summary-box">
                Auth mismatch details will appear here...
            </div>
        </div>

        <div class="last-updated" id="lastUpdated">
            Last updated: Loading...
        </div>
    </div>

    <script>
        let activeTab = 'payment';
        
        /* --------- TAB SWITCHING --------- */
        function switchTab(tabName) {
            // Update active tab styling
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Set new active tab
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
            activeTab = tabName;
            
            // Load data for the active tab
            loadActiveTabData();
        }
        
        function loadActiveTabData() {
            if (activeTab === 'payment') {
                loadPaymentData();
            } else {
                loadAuthMismatchData();
            }
        }
        
        /* --------- FORMATTING FUNCTIONS --------- */
        function fmt(value) {
            if (value === undefined || value === null) return "-";
            if (value === 0) return "-";
            return Number(value).toLocaleString();
        }
        
        function fmtCurrency(value) {
            if (value === undefined || value === null) return "$0";
            return `$${Number(value).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }
        
        function fmtDate(dateString) {
            if (!dateString) return "-";
            const date = new Date(dateString);
            return date.toLocaleString();
        }
        
        /* --------- PAYMENT DATA FUNCTIONS --------- */
        function formatPaymentSummaryText(data) {
            let usList = [];
            let caList = [];

            data.tableData.forEach(row => {
                if (row.method !== "TOTAL") {
                    if (row.US > 0) usList.push(`${row.method} (${row.US})`);
                    if (row.CA > 0) caList.push(`${row.method} (${row.CA})`);
                }
            });

            return `
                <ul>
                    <li><b>Payment order Details (${String(data.hours).padStart(2,'0')} hrs)</b> -</li>
                    <ul>
                        <li><b>US:</b> ${usList.join(", ") || "None"}</li>
                        <li><b>CA:</b> ${caList.join(", ") || "None"}</li>
                    </ul>
                </ul>
            `;
        }
        
        async function loadPaymentData() {
            const hours = document.getElementById('hoursSelect').value;
            const tableBody = document.getElementById('paymentTableBody');
            const timeRangeTitle = document.getElementById('timeRangeTitle');
            const lastUpdated = document.getElementById('lastUpdated');
            const summaryBox = document.getElementById('paymentSummaryBox');

            tableBody.innerHTML = '<tr><td colspan="4" class="loading">Loading payment data...</td></tr>';
            
            try {
                const response = await fetch(`/api/payment-summary?hours=${hours}`);
                const data = await response.json();

                if (data.success) {
                    timeRangeTitle.textContent = `Payment Details (${data.hours} hours)`;
                    
                    // Table
                    let tableHTML = '';
                    data.tableData.forEach(row => {
                        const isTotal = row.method === 'TOTAL';
                        tableHTML += `
                            <tr class="${isTotal ? 'total-row' : ''}">
                                <td style="text-align: left; padding-left: 20px;">${row.method}</td>
                                <td>${fmt(row.US)}</td>
                                <td>${fmt(row.CA)}</td>
                                <td>${fmt(row.TOTAL)}</td>
                            </tr>
                        `;
                    });
                    tableBody.innerHTML = tableHTML;

                    // Show Summary
                    summaryBox.innerHTML = formatPaymentSummaryText(data);

                    lastUpdated.textContent = `Last updated: ${data.lastUpdated}`;
                } else {
                    tableBody.innerHTML = '<tr><td colspan="4">Error loading payment data</td></tr>';
                    summaryBox.innerHTML = '<div class="error-box">Error loading payment data</div>';
                }
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="4">Error loading payment data</td></tr>';
                summaryBox.innerHTML = '<div class="error-box">Error connecting to server</div>';
                console.error('Payment data error:', error);
            }
        }
        
        /* --------- AUTH MISMATCH FUNCTIONS --------- */
        function formatAuthMismatchSummary(data) {
            return `
                <ul>
                    <li><b>Auth Mismatch Summary (${String(data.hours).padStart(2,'0')} hrs)</b></li>
                    <li>Total Orders with Mismatch: <b>${fmt(data.authMismatchCount)}</b></li>
                    <li>Total Difference Amount: <b>${fmtCurrency(data.totals?.totalDifference || 0)}</b></li>
                    <li>Total Amount Paid: <b>${fmtCurrency(data.totals?.totalAmountPaid || 0)}</b></li>
                    <li>Last Updated: ${data.lastUpdated}</li>
                </ul>
            `;
        }
        
        async function loadAuthMismatchData() {
            const hours = document.getElementById('hoursSelect').value;
            const tableBody = document.getElementById('authMismatchTableBody');
            const timeRangeTitle = document.getElementById('timeRangeTitle');
            const lastUpdated = document.getElementById('lastUpdated');
            const summaryBox = document.getElementById('authSummaryBox');
            const statsBox = document.getElementById('authStatsBox');

            tableBody.innerHTML = '<tr><td colspan="10" class="loading">Loading auth mismatch data...</td></tr>';
            
            try {
                const response = await fetch(`/api/auth-mismatch?hours=${hours}`);
                const data = await response.json();

                if (data.success) {
                    timeRangeTitle.textContent = `Auth Mismatch Details (${data.hours} hours)`;
                    
                    // Update stats cards
                    document.getElementById('authMismatchCount').textContent = fmt(data.authMismatchCount);
                    document.getElementById('totalDifference').textContent = fmtCurrency(data.totals?.totalDifference || 0);
                    document.getElementById('totalAmountPaid').textContent = fmtCurrency(data.totals?.totalAmountPaid || 0);
                    
                    // Table
                    if (data.data && data.data.length > 0) {
                        let tableHTML = '';
                        data.data.forEach(order => {
                            const diffClass = order.difference < 0 ? 'negative-diff' : 'positive-diff';
                            tableHTML += `
                                <tr class="auth-mismatch-row">
                                    <td>${fmtDate(order.placed_On)}</td>
                                    <td style="text-align: left;">${order.orderId || '-'}</td>
                                    <td>${order.site || '-'}</td>
                                    <td>${fmtCurrency(order.price_without_tax)}</td>
                                    <td>${fmtCurrency(order.UP_TAX_SHIPPING)}</td>
                                    <td>${fmtCurrency(order.amtPaid)}</td>
                                    <td class="${diffClass}">${fmtCurrency(order.difference)}</td>
                                    <td>${fmtCurrency(order.paid_CC_PAYPAL)}</td>
                                    <td>${fmtCurrency(order.GC_REWARDCARD_amt)}</td>
                                    <td>${order.paymentCount || '-'}</td>
                                </tr>
                            `;
                        });
                        tableBody.innerHTML = tableHTML;
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No auth mismatch orders found</td></tr>';
                    }

                    // Show Summary
                    summaryBox.innerHTML = formatAuthMismatchSummary(data);

                    lastUpdated.textContent = `Last updated: ${data.lastUpdated}`;
                } else {
                    tableBody.innerHTML = '<tr><td colspan="10">Error loading auth mismatch data</td></tr>';
                    summaryBox.innerHTML = '<div class="error-box">Error loading auth mismatch data</div>';
                }
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="10">Error loading auth mismatch data</td></tr>';
                summaryBox.innerHTML = '<div class="error-box">Error connecting to server</div>';
                console.error('Auth mismatch data error:', error);
            }
        }
        
        /* --------- INITIALIZATION --------- */
        document.addEventListener('DOMContentLoaded', () => {
            loadPaymentData();
            
            // Auto-refresh every 5 minutes for active tab
            setInterval(() => {
                loadActiveTabData();
            }, 300000);
        });
    </script>
</body>
</html>